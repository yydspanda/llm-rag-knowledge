LangChain 结合原文进行讲解: 如何单独使用提示（不进行工具调用）来完成提取

在 LangChain 中，信息提取指的是从文本中识别并抽取出结构化数据的过程，这个过程可以不依赖于模型的工具调用（Tool Calling）功能，仅通过设计良好的提示（Prompt）和输出解析器（Output Parser）来实现。

### 核心理念

该方法的核心思想是：

1.  **指令明确的提示**: 指示语言模型（LLM）按照特定的格式（如 JSON）生成文本。
2.  **输出解析**: 使用输出解析器将模型的文本响应转换成程序可以直接使用的结构化对象（如 Python 对象）。

### 使用 `PydanticOutputParser`

LangChain 提供了 `PydanticOutputParser`，它能够利用 Pydantic 模型来定义所需的数据结构，并自动生成相应的格式化指令。

**步骤如下**:

1.  **定义数据结构**: 使用 Pydantic 的 `BaseModel` 定义你想要提取的数据的结构。例如，定义一个 `Person` 类，包含 `name` 和 `height_in_meters` 字段。

    ```python
    from pydantic import BaseModel, Field
    from typing import List

    class Person(BaseModel):
        """关于一个人的信息。"""
        name: str = Field(..., description="人的姓名")
        height_in_meters: float = Field(..., description="以米为单位的身高")

    class People(BaseModel):
        """文本中所有人的识别信息。"""
        people: List[Person]
    ```

2.  **创建解析器**: 基于定义好的 Pydantic 模型创建一个 `PydanticOutputParser` 实例。

    ```python
    from langchain_core.output_parsers import PydanticOutputParser

    parser = PydanticOutputParser(pydantic_object=People)
    ```

3.  **构建提示模板**: 创建一个提示模板，其中包含 `format_instructions` 占位符，用于接收解析器生成的格式化指令。这些指令会告诉模型应该如何构造输出的 JSON。

    ```python
    from langchain_core.prompts import ChatPromptTemplate

    prompt = ChatPromptTemplate.from_messages([
        ("system", "回答用户查询。将输出包裹在 `json` 标签中\n{format_instructions}"),
        ("human", "{query}"),
    ]).partial(format_instructions=parser.get_format_instructions())
    ```

4.  **构建并调用链**: 将提示、模型和解析器连接成一个链（Chain），然后调用它。

    ```python
    chain = prompt | model | parser
    chain.invoke({"query": "安娜今年23岁，身高6英尺"})
    ```

    在这个过程中，`parser.get_format_instructions()` 会将 Pydantic 模型的结构转换成 JSON Schema，并将其插入到提示中，从而指导模型生成符合预期的 JSON 输出。最后，解析器再将模型输出的 JSON 字符串解析成 Pydantic 对象。

### 自定义解析

如果你需要更灵活的解析方式，可以自定义解析函数。

**步骤如下**:

1.  **定义数据结构和提示**: 与之前类似，首先定义 Pydantic 模型，然后创建一个提示，明确要求模型输出符合特定 schema 的 JSON，并用 ```json ... ``` 标签包裹。

2.  **编写自定义解析函数**: 创建一个函数，接收模型的输出消息（`AIMessage`），并从中提取出 JSON 内容。这通常需要使用正则表达式来定位被特定标签（如 ```json```）包裹的 JSON 字符串。

    ```python
    import json
    import re
    from langchain_core.messages import AIMessage

    def extract_json(message: AIMessage) -> List[dict]:
        text = message.content
        pattern = r"```json(.*?)```"
        matches = re.findall(pattern, text, re.DOTALL)
        try:
            return [json.loads(match.strip()) for match in matches]
        except Exception:
            raise ValueError(f"Failed to parse: {message}")
    ```

3.  **构建链**: 将提示、模型和自定义的解析函数连接起来。

    ```python
    chain = prompt | model | extract_json
    chain.invoke({"query": "安娜今年23岁，身高6英尺"})
    ```

这种方法虽然需要手动编写解析逻辑，但提供了更高的自由度，可以应对更复杂的输出格式。

### 其他库

如果你希望通过更高级的方式来处理提取，可以关注 Kor 库。它是由 LangChain 的维护者之一编写的，可以帮助构建包含示例的提示，并能以 TypeScript 的形式来表达数据模式。